/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var fs = require('fs');
var cp = require('child_process');
var assert = require('assert');
var net = require('net');
var protocolClient_1 = require('./protocolClient');
var DebugClient = (function (_super) {
    __extends(DebugClient, _super);
    /**
     * Creates a DebugClient object that provides a promise-based API to write
     * debug adapter tests.
     * A simple mocha example for setting and hitting a breakpoint in line 15 of a program 'test.js' looks like this:
     *
     * var dc;
     * setup( () => {
     *     dc = new DebugClient('node', './out/node/nodeDebug.js', 'node');
     *     return dc.start();
     * });
     * teardown( () => dc.stop() );
     *
     * test('should stop on a breakpoint', () => {
     *     return dc.hitBreakpoint({ program: 'test.js' }, 'test.js', 15);
     * });
     */
    function DebugClient(runtime, executable, debugType) {
        _super.call(this);
        this.defaultTimeout = 5000;
        this._runtime = runtime;
        this._executable = executable;
        this._enableStderr = false;
        this._debugType = debugType;
        this._supportsConfigurationDoneRequest = false;
        if (DebugClient.CASE_INSENSITIVE_FILESYSTEM === undefined) {
            try {
                fs.accessSync(process.execPath.toLowerCase(), fs.F_OK);
                fs.accessSync(process.execPath.toUpperCase(), fs.F_OK);
                DebugClient.CASE_INSENSITIVE_FILESYSTEM = true;
            }
            catch (err) {
                DebugClient.CASE_INSENSITIVE_FILESYSTEM = false;
            }
        }
    }
    // ---- life cycle --------------------------------------------------------------------------------------------------------
    /**
     * Starts a new debug adapter and sets up communication via stdin/stdout.
     * If a port number is specified the adapter is not launched but a connection to
     * a debug adapter running in server mode is established. This is useful for debugging
     * the adapter while running tests. For this reason all timeouts are disabled in server mode.
     */
    DebugClient.prototype.start = function (port) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (typeof port === 'number') {
                _this._socket = net.createConnection(port, '127.0.0.1', function () {
                    _this.connect(_this._socket, _this._socket);
                    resolve();
                });
            }
            else {
                _this._adapterProcess = cp.spawn(_this._runtime, [_this._executable]);
                var sanitize_1 = function (s) { return s.toString().replace(/\r?\n$/mg, ''); };
                _this._adapterProcess.stderr.on('data', function (data) {
                    if (_this._enableStderr) {
                        console.log(sanitize_1(data));
                    }
                });
                _this._adapterProcess.on('error', function (err) {
                    console.log(err);
                    reject(err);
                });
                _this._adapterProcess.on('exit', function (code, signal) {
                    if (code) {
                    }
                });
                _this.connect(_this._adapterProcess.stdout, _this._adapterProcess.stdin);
                resolve();
            }
        });
    };
    /**
     * Shutdown the debuggee and the debug adapter (or disconnect if in server mode).
     */
    DebugClient.prototype.stop = function () {
        var _this = this;
        return this.disconnectRequest().then(function () {
            _this.stopAdapter();
        }).catch(function () {
            _this.stopAdapter();
        });
    };
    DebugClient.prototype.stopAdapter = function () {
        if (this._adapterProcess) {
            this._adapterProcess.kill();
            this._adapterProcess = null;
        }
        if (this._socket) {
            this._socket.end();
            this._socket = null;
        }
    };
    // ---- protocol requests -------------------------------------------------------------------------------------------------
    DebugClient.prototype.initializeRequest = function (args) {
        if (!args) {
            args = {
                adapterID: this._debugType,
                linesStartAt1: true,
                columnsStartAt1: true,
                pathFormat: 'path'
            };
        }
        return this.send('initialize', args);
    };
    DebugClient.prototype.configurationDoneRequest = function (args) {
        return this.send('configurationDone', args);
    };
    DebugClient.prototype.launchRequest = function (args) {
        return this.send('launch', args);
    };
    DebugClient.prototype.attachRequest = function (args) {
        return this.send('attach', args);
    };
    DebugClient.prototype.disconnectRequest = function (args) {
        return this.send('disconnect', args);
    };
    DebugClient.prototype.setBreakpointsRequest = function (args) {
        return this.send('setBreakpoints', args);
    };
    DebugClient.prototype.setFunctionBreakpointsRequest = function (args) {
        return this.send('setFunctionBreakpoints', args);
    };
    DebugClient.prototype.setExceptionBreakpointsRequest = function (args) {
        return this.send('setExceptionBreakpoints', args);
    };
    DebugClient.prototype.continueRequest = function (args) {
        return this.send('continue', args);
    };
    DebugClient.prototype.nextRequest = function (args) {
        return this.send('next', args);
    };
    DebugClient.prototype.stepInRequest = function (args) {
        return this.send('stepIn', args);
    };
    DebugClient.prototype.stepOutRequest = function (args) {
        return this.send('stepOut', args);
    };
    DebugClient.prototype.pauseRequest = function (args) {
        return this.send('pause', args);
    };
    DebugClient.prototype.stackTraceRequest = function (args) {
        return this.send('stackTrace', args);
    };
    DebugClient.prototype.scopesRequest = function (args) {
        return this.send('scopes', args);
    };
    DebugClient.prototype.variablesRequest = function (args) {
        return this.send('variables', args);
    };
    DebugClient.prototype.sourceRequest = function (args) {
        return this.send('source', args);
    };
    DebugClient.prototype.threadsRequest = function () {
        return this.send('threads');
    };
    DebugClient.prototype.evaluateRequest = function (args) {
        return this.send('evaluate', args);
    };
    // ---- convenience methods -----------------------------------------------------------------------------------------------
    /*
     * Returns a promise that will resolve if an event with a specific type was received within some specified time.
     * The promise will be rejected if a timeout occurs.
     */
    DebugClient.prototype.waitForEvent = function (eventType, timeout) {
        var _this = this;
        timeout = timeout || this.defaultTimeout;
        return new Promise(function (resolve, reject) {
            _this.on(eventType, function (event) {
                resolve(event);
            });
            if (!_this._socket) {
                setTimeout(function () {
                    reject(new Error("no event '" + eventType + "' received after " + timeout + " ms"));
                }, timeout);
            }
        });
    };
    /*
     * Returns a promise that will resolve if an 'initialized' event was received within some specified time
     * and a subsequent 'configurationDone' request was successfully executed.
     * The promise will be rejected if a timeout occurs or if the 'configurationDone' request fails.
     */
    DebugClient.prototype.configurationSequence = function () {
        var _this = this;
        return this.waitForEvent('initialized').then(function (event) {
            return _this.configurationDone();
        });
    };
    /**
     * Returns a promise that will resolve if a 'initialize' and a 'launch' request were successful.
     */
    DebugClient.prototype.launch = function (launchArgs) {
        var _this = this;
        return this.initializeRequest().then(function (response) {
            if (response.body && response.body.supportsConfigurationDoneRequest) {
                _this._supportsConfigurationDoneRequest = true;
            }
            return _this.launchRequest(launchArgs);
        });
    };
    DebugClient.prototype.configurationDone = function () {
        if (this._supportsConfigurationDoneRequest) {
            return this.configurationDoneRequest();
        }
        else {
            // if debug adapter doesn't support the configurationDoneRequest we have to send the setExceptionBreakpointsRequest.
            return this.setExceptionBreakpointsRequest({ filters: ['all'] });
        }
    };
    /*
     * Returns a promise that will resolve if a 'stopped' event was received within some specified time
     * and the event's reason and line number was asserted.
     * The promise will be rejected if a timeout occurs, the assertions fail, or if the 'stackTrace' request fails.
     */
    DebugClient.prototype.assertStoppedLocation = function (reason, expected) {
        var _this = this;
        return this.waitForEvent('stopped').then(function (event) {
            assert.equal(event.body.reason, reason);
            return _this.stackTraceRequest({
                threadId: event.body.threadId
            });
        }).then(function (response) {
            var frame = response.body.stackFrames[0];
            if (typeof expected.path === 'string') {
                _this.assertPath(frame.source.path, expected.path, 'stopped location: path mismatch');
            }
            if (typeof expected.line === 'number') {
                assert.equal(frame.line, expected.line, 'stopped location: line mismatch');
            }
            if (typeof expected.column === 'number') {
                assert.equal(frame.column, expected.column, 'stopped location: column mismatch');
            }
            return response;
        });
    };
    /*
     * Returns a promise that will resolve if enough output events with the given category have been received
     * and the concatenated data match the expected data.
     * The promise will be rejected as soon as the received data cannot match the expected data or if a timeout occurs.
     */
    DebugClient.prototype.assertOutput = function (category, expected, timeout) {
        var _this = this;
        timeout = timeout || this.defaultTimeout;
        return new Promise(function (resolve, reject) {
            var output = '';
            _this.on('output', function (event) {
                var e = event;
                if (e.body.category === category) {
                    output += e.body.output;
                    if (output.indexOf(expected) === 0) {
                        resolve(event);
                    }
                    else if (expected.indexOf(output) !== 0) {
                        var sanitize = function (s) { return s.toString().replace(/\r/mg, '\\r').replace(/\n/mg, '\\n'); };
                        reject(new Error("received data '" + sanitize(output) + "' is not a prefix of the expected data '" + sanitize(expected) + "'"));
                    }
                }
            });
            if (!_this._socket) {
                setTimeout(function () {
                    reject(new Error("not enough output data received after " + timeout + " ms"));
                }, timeout);
            }
        });
    };
    DebugClient.prototype.assertPath = function (path, expected, message) {
        if (DebugClient.CASE_INSENSITIVE_FILESYSTEM) {
            if (typeof path === 'string') {
                path = path.toLowerCase();
            }
            if (typeof expected === 'string') {
                expected = expected.toLowerCase();
            }
        }
        assert.equal(path, expected, message);
    };
    // ---- scenarios ---------------------------------------------------------------------------------------------------------
    /**
     * Returns a promise that will resolve if a configurable breakpoint has been hit within some time
     * and the event's reason and line number was asserted.
     * The promise will be rejected if a timeout occurs, the assertions fail, or if the requests fails.
     */
    DebugClient.prototype.hitBreakpoint = function (launchArgs, location, expected) {
        var _this = this;
        return Promise.all([
            this.waitForEvent('initialized').then(function (event) {
                return _this.setBreakpointsRequest({
                    lines: [location.line],
                    breakpoints: [{ line: location.line, column: location.column }],
                    source: { path: location.path }
                });
            }).then(function (response) {
                var bp = response.body.breakpoints[0];
                var verified = (typeof location.verified === 'boolean') ? location.verified : true;
                assert.equal(bp.verified, verified, 'breakpoint verification mismatch: verified');
                if (bp.source && bp.source.path) {
                    _this.assertPath(bp.source.path, location.path, 'breakpoint verification mismatch: path');
                }
                if (typeof bp.line === 'number') {
                    assert.equal(bp.line, location.line, 'breakpoint verification mismatch: line');
                }
                if (typeof location.column === 'number' && typeof bp.column === 'number') {
                    assert.equal(bp.column, location.column, 'breakpoint verification mismatch: column');
                }
                return _this.configurationDone();
            }),
            this.launch(launchArgs),
            this.assertStoppedLocation('breakpoint', expected || location)
        ]);
    };
    return DebugClient;
}(protocolClient_1.ProtocolClient));
exports.DebugClient = DebugClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVidWdDbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZGVidWdDbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztnR0FHZ0c7Ozs7Ozs7QUFFaEcsSUFBTyxFQUFFLFdBQVcsSUFBSSxDQUFDLENBQUM7QUFDMUIsSUFBTyxFQUFFLFdBQVcsZUFBZSxDQUFDLENBQUM7QUFDckMsSUFBTyxNQUFNLFdBQVcsUUFBUSxDQUFDLENBQUM7QUFDbEMsSUFBTyxHQUFHLFdBQVcsS0FBSyxDQUFDLENBQUM7QUFFNUIsK0JBQTZCLGtCQUFrQixDQUFDLENBQUE7QUFFaEQ7SUFBaUMsK0JBQWM7SUFlOUM7Ozs7Ozs7Ozs7Ozs7OztPQWVHO0lBQ0gscUJBQVksT0FBZSxFQUFFLFVBQWtCLEVBQUUsU0FBaUI7UUFDakUsaUJBQU8sQ0FBQztRQW5CRixtQkFBYyxHQUFHLElBQUksQ0FBQztRQW9CNUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7UUFDeEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUM7UUFDOUIsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7UUFDM0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7UUFDNUIsSUFBSSxDQUFDLGlDQUFpQyxHQUFHLEtBQUssQ0FBQztRQUUvQyxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsMkJBQTJCLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUMzRCxJQUFJLENBQUM7Z0JBQ0osRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDdkQsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDdkQsV0FBVyxDQUFDLDJCQUEyQixHQUFHLElBQUks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QUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztZQUNqQyxDQUFDLENBQUM7WUFFRixJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztZQUV2QixJQUFJLENBQUMscUJBQXFCLENBQUMsWUFBWSxFQUFFLFFBQVEsSUFBSSxRQUFRLENBQUM7U0FFOUQsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUNGLGtCQUFDO0FBQUQsQ0FBQyxBQWhYRCxDQUFpQywrQkFBYyxHQWdYOUM7QUFoWFksbUJBQVcsY0FnWHZCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICogIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4gU2VlIExpY2Vuc2UudHh0IGluIHRoZSBwcm9qZWN0IHJvb3QgZm9yIGxpY2Vuc2UgaW5mb3JtYXRpb24uXG4gKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cblxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmltcG9ydCBjcCA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTtcbmltcG9ydCBhc3NlcnQgPSByZXF1aXJlKCdhc3NlcnQnKTtcbmltcG9ydCBuZXQgPSByZXF1aXJlKCduZXQnKTtcbmltcG9ydCB7RGVidWdQcm90b2NvbH0gZnJvbSAndnNjb2RlLWRlYnVncHJvdG9jb2wnO1xuaW1wb3J0IHtQcm90b2NvbENsaWVudH0gZnJvbSAnLi9wcm90b2NvbENsaWVudCc7XG5cbmV4cG9ydCBjbGFzcyBEZWJ1Z0NsaWVudCBleHRlbmRzIFByb3RvY29sQ2xpZW50IHtcblxuXHRwcml2YXRlIHN0YXRpYyBDQVNFX0lOU0VOU0lUSVZFX0ZJTEVTWVNURU0gOiBib29sZWFuO1xuXG5cdHByaXZhdGUgX3J1bnRpbWU6IHN0cmluZztcblx0cHJpdmF0ZSBfZXhlY3V0YWJsZTogc3RyaW5nO1xuXHRwcml2YXRlIF9hZGFwdGVyUHJvY2VzczogY3AuQ2hpbGRQcm9jZXNzO1xuXHRwcml2YXRlIF9lbmFibGVTdGRlcnI6IGJvb2xlYW47XG5cdHByaXZhdGUgX2RlYnVnVHlwZTogc3RyaW5nO1xuXHRwcml2YXRlIF9zb2NrZXQ6IG5ldC5Tb2NrZXQ7XG5cblx0cHJpdmF0ZSBfc3VwcG9ydHNDb25maWd1cmF0aW9uRG9uZVJlcXVlc3Q6IGJvb2xlYW47XG5cblx0cHVibGljIGRlZmF1bHRUaW1lb3V0ID0gNTAwMDtcblxuXHQvKipcblx0ICogQ3JlYXRlcyBhIERlYnVnQ2xpZW50IG9iamVjdCB0aGF0IHByb3ZpZGVzIGEgcHJvbWlzZS1iYXNlZCBBUEkgdG8gd3JpdGVcblx0ICogZGVidWcgYWRhcHRlciB0ZXN0cy5cblx0ICogQSBzaW1wbGUgbW9jaGEgZXhhbXBsZSBmb3Igc2V0dGluZyBhbmQgaGl0dGluZyBhIGJyZWFrcG9pbnQgaW4gbGluZSAxNSBvZiBhIHByb2dyYW0gJ3Rlc3QuanMnIGxvb2tzIGxpa2UgdGhpczpcblx0ICpcblx0ICogdmFyIGRjO1xuXHQgKiBzZXR1cCggKCkgPT4ge1xuXHQgKiAgICAgZGMgPSBuZXcgRGVidWdDbGllbnQoJ25vZGUnLCAnLi9vdXQvbm9kZS9ub2RlRGVidWcuanMnLCAnbm9kZScpO1xuXHQgKiAgICAgcmV0dXJuIGRjLnN0YXJ0KCk7XG5cdCAqIH0pO1xuXHQgKiB0ZWFyZG93biggKCkgPT4gZGMuc3RvcCgpICk7XG5cdCAqXG5cdCAqIHRlc3QoJ3Nob3VsZCBzdG9wIG9uIGEgYnJlYWtwb2ludCcsICgpID0+IHtcblx0ICogICAgIHJldHVybiBkYy5oaXRCcmVha3BvaW50KHsgcHJvZ3JhbTogJ3Rlc3QuanMnIH0sICd0ZXN0LmpzJywgMTUpO1xuXHQgKiB9KTtcblx0ICovXG5cdGNvbnN0cnVjdG9yKHJ1bnRpbWU6IHN0cmluZywgZXhlY3V0YWJsZTogc3RyaW5nLCBkZWJ1Z1R5cGU6IHN0cmluZykge1xuXHRcdHN1cGVyKCk7XG5cdFx0dGhpcy5fcnVudGltZSA9IHJ1bnRpbWU7XG5cdFx0dGhpcy5fZXhlY3V0YWJsZSA9IGV4ZWN1dGFibGU7XG5cdFx0dGhpcy5fZW5hYmxlU3RkZXJyID0gZmFsc2U7XG5cdFx0dGhpcy5fZGVidWdUeXBlID0gZGVidWdUeXBlO1xuXHRcdHRoaXMuX3N1cHBvcnRzQ29uZmlndXJhdGlvbkRvbmVSZXF1ZXN0ID0gZmFsc2U7XG5cblx0XHRpZiAoRGVidWdDbGllbnQuQ0FTRV9JTlNFTlNJVElWRV9GSUxFU1lTVEVNID09PSB1bmRlZmluZWQpIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGZzLmFjY2Vzc1N5bmMocHJvY2Vzcy5leGVjUGF0aC50b0xvd2VyQ2FzZSgpLCBmcy5GX09LKTtcblx0XHRcdFx0ZnMuYWNjZXNzU3luYyhwcm9jZXNzLmV4ZWNQYXRoLnRvVXBwZXJDYXNlKCksIGZzLkZfT0spO1xuXHRcdFx0XHREZWJ1Z0NsaWVudC5DQVNFX0lOU0VOU0lUSVZFX0ZJTEVTWVNURU0gPSB0cnVlO1xuXHRcdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRcdERlYnVnQ2xpZW50LkNBU0VfSU5TRU5TSVRJVkVfRklMRVNZU1RFTSA9IGZhbHNlO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdC8vIC0tLS0gbGlmZSBjeWNsZSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5cdC8qKlxuXHQgKiBTdGFydHMgYSBuZXcgZGVidWcgYWRhcHRlciBhbmQgc2V0cyB1cCBjb21tdW5pY2F0aW9uIHZpYSBzdGRpbi9zdGRvdXQuXG5cdCAqIElmIGEgcG9ydCBudW1iZXIgaXMgc3BlY2lmaWVkIHRoZSBhZGFwdGVyIGlzIG5vdCBsYXVuY2hlZCBidXQgYSBjb25uZWN0aW9uIHRvXG5cdCAqIGEgZGVidWcgYWRhcHRlciBydW5uaW5nIGluIHNlcnZlciBtb2RlIGlzIGVzdGFibGlzaGVkLiBUaGlzIGlzIHVzZWZ1bCBmb3IgZGVidWdnaW5nXG5cdCAqIHRoZSBhZGFwdGVyIHdoaWxlIHJ1bm5pbmcgdGVzdHMuIEZvciB0aGlzIHJlYXNvbiBhbGwgdGltZW91dHMgYXJlIGRpc2FibGVkIGluIHNlcnZlciBtb2RlLlxuXHQgKi9cblx0cHVibGljIHN0YXJ0KHBvcnQ/OiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcblxuXHRcdHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHRpZiAodHlwZW9mIHBvcnQgPT09ICdudW1iZXInKSB7XG5cdFx0XHRcdHRoaXMuX3NvY2tldCA9IG5ldC5jcmVhdGVDb25uZWN0aW9uKHBvcnQsICcxMjcuMC4wLjEnLCAoKSA9PiB7XG5cdFx0XHRcdFx0dGhpcy5jb25uZWN0KHRoaXMuX3NvY2tldCwgdGhpcy5fc29ja2V0KTtcblx0XHRcdFx0XHRyZXNvbHZlKCk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5fYWRhcHRlclByb2Nlc3MgPSBjcC5zcGF3bih0aGlzLl9ydW50aW1lLCBbIHRoaXMuX2V4ZWN1dGFibGUgXSk7XG5cdFx0XHRcdGNvbnN0IHNhbml0aXplID0gKHM6IHN0cmluZykgPT4gcy50b1N0cmluZygpLnJlcGxhY2UoL1xccj9cXG4kL21nLCAnJyk7XG5cdFx0XHRcdHRoaXMuX2FkYXB0ZXJQcm9jZXNzLnN0ZGVyci5vbignZGF0YScsIChkYXRhOiBzdHJpbmcpID0+IHtcblx0XHRcdFx0XHRpZiAodGhpcy5fZW5hYmxlU3RkZXJyKSB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhzYW5pdGl6ZShkYXRhKSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHR0aGlzLl9hZGFwdGVyUHJvY2Vzcy5vbignZXJyb3InLCAoZXJyKSA9PiB7XG5cdFx0XHRcdFx0Y29uc29sZS5sb2coZXJyKTtcblx0XHRcdFx0XHRyZWplY3QoZXJyKTtcblx0XHRcdFx0fSk7XG5cdFx0XHRcdHRoaXMuX2FkYXB0ZXJQcm9jZXNzLm9uKCdleGl0JywgKGNvZGU6IG51bWJlciwgc2lnbmFsOiBzdHJpbmcpID0+IHtcblx0XHRcdFx0XHRpZiAoY29kZSkge1xuXHRcdFx0XHRcdFx0Ly8gZG9uZShuZXcgRXJyb3IoJ2RlYnVnIGFkYXB0ZXIgZXhpdCBjb2RlOiAnICsgY29kZSkpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cblx0XHRcdFx0dGhpcy5jb25uZWN0KHRoaXMuX2FkYXB0ZXJQcm9jZXNzLnN0ZG91dCwgdGhpcy5fYWRhcHRlclByb2Nlc3Muc3RkaW4pO1xuXHRcdFx0XHRyZXNvbHZlKCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHQvKipcblx0ICogU2h1dGRvd24gdGhlIGRlYnVnZ2VlIGFuZCB0aGUgZGVidWcgYWRhcHRlciAob3IgZGlzY29ubmVjdCBpZiBpbiBzZXJ2ZXIgbW9kZSkuXG5cdCAqL1xuXHRwdWJsaWMgc3RvcCgpOiBQcm9taXNlPHZvaWQ+IHtcblxuXHRcdHJldHVybiB0aGlzLmRpc2Nvbm5lY3RSZXF1ZXN0KCkudGhlbigoKSA9PiB7XG5cdFx0XHR0aGlzLnN0b3BBZGFwdGVyKCk7XG5cdFx0fSkuY2F0Y2goKCkgPT4ge1xuXHRcdFx0dGhpcy5zdG9wQWRhcHRlcigpO1xuXHRcdH0pO1xuXHR9XG5cblx0cHJpdmF0ZSBzdG9wQWRhcHRlcigpIHtcblx0XHRpZiAodGhpcy5fYWRhcHRlclByb2Nlc3MpIHtcblx0XHRcdHRoaXMuX2FkYXB0ZXJQcm9jZXNzLmtpbGwoKTtcblx0XHRcdHRoaXMuX2FkYXB0ZXJQcm9jZXNzID0gbnVsbDtcblx0XHR9XG5cdFx0aWYgKHRoaXMuX3NvY2tldCkge1xuXHRcdFx0dGhpcy5fc29ja2V0LmVuZCgpO1xuXHRcdFx0dGhpcy5fc29ja2V0ID0gbnVsbDtcblx0XHR9XG5cdH1cblxuXHQvLyAtLS0tIHByb3RvY29sIHJlcXVlc3RzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuXHRwdWJsaWMgaW5pdGlhbGl6ZVJlcXVlc3QoYXJncz86IERlYnVnUHJvdG9jb2wuSW5pdGlhbGl6ZVJlcXVlc3RBcmd1bWVudHMpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuSW5pdGlhbGl6ZVJlc3BvbnNlPiB7XG5cdFx0aWYgKCFhcmdzKSB7XG5cdFx0XHRhcmdzID0ge1xuXHRcdFx0XHRhZGFwdGVySUQ6IHRoaXMuX2RlYnVnVHlwZSxcblx0XHRcdFx0bGluZXNTdGFydEF0MTogdHJ1ZSxcblx0XHRcdFx0Y29sdW1uc1N0YXJ0QXQxOiB0cnVlLFxuXHRcdFx0XHRwYXRoRm9ybWF0OiAncGF0aCdcblx0XHRcdH07XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzLnNlbmQoJ2luaXRpYWxpemUnLCBhcmdzKTtcblx0fVxuXG5cdHB1YmxpYyBjb25maWd1cmF0aW9uRG9uZVJlcXVlc3QoYXJncz86IERlYnVnUHJvdG9jb2wuQ29uZmlndXJhdGlvbkRvbmVBcmd1bWVudHMpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuQ29uZmlndXJhdGlvbkRvbmVSZXNwb25zZT4ge1xuXHRcdHJldHVybiB0aGlzLnNlbmQoJ2NvbmZpZ3VyYXRpb25Eb25lJywgYXJncyk7XG5cdH1cblxuXHRwdWJsaWMgbGF1bmNoUmVxdWVzdChhcmdzOiBEZWJ1Z1Byb3RvY29sLkxhdW5jaFJlcXVlc3RBcmd1bWVudHMpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuTGF1bmNoUmVzcG9uc2U+IHtcblx0XHRyZXR1cm4gdGhpcy5zZW5kKCdsYXVuY2gnLCBhcmdzKTtcblx0fVxuXG5cdHB1YmxpYyBhdHRhY2hSZXF1ZXN0KGFyZ3M6IERlYnVnUHJvdG9jb2wuQXR0YWNoUmVxdWVzdEFyZ3VtZW50cyk6IFByb21pc2U8RGVidWdQcm90b2NvbC5BdHRhY2hSZXNwb25zZT4ge1xuXHRcdHJldHVybiB0aGlzLnNlbmQoJ2F0dGFjaCcsIGFyZ3MpO1xuXHR9XG5cblx0cHVibGljIGRpc2Nvbm5lY3RSZXF1ZXN0KGFyZ3M/OiBEZWJ1Z1Byb3RvY29sLkRpc2Nvbm5lY3RBcmd1bWVudHMpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuRGlzY29ubmVjdFJlc3BvbnNlPiB7XG5cdFx0cmV0dXJuIHRoaXMuc2VuZCgnZGlzY29ubmVjdCcsIGFyZ3MpO1xuXHR9XG5cblx0cHVibGljIHNldEJyZWFrcG9pbnRzUmVxdWVzdChhcmdzOiBEZWJ1Z1Byb3RvY29sLlNldEJyZWFrcG9pbnRzQXJndW1lbnRzKTogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlNldEJyZWFrcG9pbnRzUmVzcG9uc2U+IHtcblx0XHRyZXR1cm4gdGhpcy5zZW5kKCdzZXRCcmVha3BvaW50cycsIGFyZ3MpO1xuXHR9XG5cblx0cHVibGljIHNldEZ1bmN0aW9uQnJlYWtwb2ludHNSZXF1ZXN0KGFyZ3M6IERlYnVnUHJvdG9jb2wuU2V0RnVuY3Rpb25CcmVha3BvaW50c0FyZ3VtZW50cyk6IFByb21pc2U8RGVidWdQcm90b2NvbC5TZXRGdW5jdGlvbkJyZWFrcG9pbnRzUmVzcG9uc2U+IHtcblx0XHRyZXR1cm4gdGhpcy5zZW5kKCdzZXRGdW5jdGlvbkJyZWFrcG9pbnRzJywgYXJncyk7XG5cdH1cblxuXHRwdWJsaWMgc2V0RXhjZXB0aW9uQnJlYWtwb2ludHNSZXF1ZXN0KGFyZ3M6IERlYnVnUHJvdG9jb2wuU2V0RXhjZXB0aW9uQnJlYWtwb2ludHNBcmd1bWVudHMpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU2V0RXhjZXB0aW9uQnJlYWtwb2ludHNSZXNwb25zZT4ge1xuXHRcdHJldHVybiB0aGlzLnNlbmQoJ3NldEV4Y2VwdGlvbkJyZWFrcG9pbnRzJywgYXJncyk7XG5cdH1cblxuXHRwdWJsaWMgY29udGludWVSZXF1ZXN0KGFyZ3M6IERlYnVnUHJvdG9jb2wuQ29udGludWVBcmd1bWVudHMpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuQ29udGludWVSZXNwb25zZT4ge1xuXHRcdHJldHVybiB0aGlzLnNlbmQoJ2NvbnRpbnVlJywgYXJncyk7XG5cdH1cblxuXHRwdWJsaWMgbmV4dFJlcXVlc3QoYXJnczogRGVidWdQcm90b2NvbC5OZXh0QXJndW1lbnRzKTogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLk5leHRSZXNwb25zZT4ge1xuXHRcdHJldHVybiB0aGlzLnNlbmQoJ25leHQnLCBhcmdzKTtcblx0fVxuXG5cdHB1YmxpYyBzdGVwSW5SZXF1ZXN0KGFyZ3M6IERlYnVnUHJvdG9jb2wuU3RlcEluQXJndW1lbnRzKTogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlN0ZXBJblJlc3BvbnNlPiB7XG5cdFx0cmV0dXJuIHRoaXMuc2VuZCgnc3RlcEluJywgYXJncyk7XG5cdH1cblxuXHRwdWJsaWMgc3RlcE91dFJlcXVlc3QoYXJnczogRGVidWdQcm90b2NvbC5TdGVwT3V0QXJndW1lbnRzKTogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlN0ZXBPdXRSZXNwb25zZT4ge1xuXHRcdHJldHVybiB0aGlzLnNlbmQoJ3N0ZXBPdXQnLCBhcmdzKTtcblx0fVxuXG5cdHB1YmxpYyBwYXVzZVJlcXVlc3QoYXJnczogRGVidWdQcm90b2NvbC5QYXVzZUFyZ3VtZW50cyk6IFByb21pc2U8RGVidWdQcm90b2NvbC5QYXVzZVJlc3BvbnNlPiB7XG5cdFx0cmV0dXJuIHRoaXMuc2VuZCgncGF1c2UnLCBhcmdzKTtcblx0fVxuXG5cdHB1YmxpYyBzdGFja1RyYWNlUmVxdWVzdChhcmdzOiBEZWJ1Z1Byb3RvY29sLlN0YWNrVHJhY2VBcmd1bWVudHMpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU3RhY2tUcmFjZVJlc3BvbnNlPiB7XG5cdFx0cmV0dXJuIHRoaXMuc2VuZCgnc3RhY2tUcmFjZScsIGFyZ3MpO1xuXHR9XG5cblx0cHVibGljIHNjb3Blc1JlcXVlc3QoYXJnczogRGVidWdQcm90b2NvbC5TY29wZXNBcmd1bWVudHMpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU2NvcGVzUmVzcG9uc2U+IHtcblx0XHRyZXR1cm4gdGhpcy5zZW5kKCdzY29wZXMnLCBhcmdzKTtcblx0fVxuXG5cdHB1YmxpYyB2YXJpYWJsZXNSZXF1ZXN0KGFyZ3M6IERlYnVnUHJvdG9jb2wuVmFyaWFibGVzQXJndW1lbnRzKTogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlZhcmlhYmxlc1Jlc3BvbnNlPiB7XG5cdFx0cmV0dXJuIHRoaXMuc2VuZCgndmFyaWFibGVzJywgYXJncyk7XG5cdH1cblxuXHRwdWJsaWMgc291cmNlUmVxdWVzdChhcmdzOiBEZWJ1Z1Byb3RvY29sLlNvdXJjZUFyZ3VtZW50cyk6IFByb21pc2U8RGVidWdQcm90b2NvbC5Tb3VyY2VSZXNwb25zZT4ge1xuXHRcdHJldHVybiB0aGlzLnNlbmQoJ3NvdXJjZScsIGFyZ3MpO1xuXHR9XG5cblx0cHVibGljIHRocmVhZHNSZXF1ZXN0KCk6IFByb21pc2U8RGVidWdQcm90b2NvbC5UaHJlYWRzUmVzcG9uc2U+IHtcblx0XHRyZXR1cm4gdGhpcy5zZW5kKCd0aHJlYWRzJyk7XG5cdH1cblxuXHRwdWJsaWMgZXZhbHVhdGVSZXF1ZXN0KGFyZ3M6IERlYnVnUHJvdG9jb2wuRXZhbHVhdGVBcmd1bWVudHMpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuRXZhbHVhdGVSZXNwb25zZT4ge1xuXHRcdHJldHVybiB0aGlzLnNlbmQoJ2V2YWx1YXRlJywgYXJncyk7XG5cdH1cblxuXHQvLyAtLS0tIGNvbnZlbmllbmNlIG1ldGhvZHMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuXHQvKlxuXHQgKiBSZXR1cm5zIGEgcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSBpZiBhbiBldmVudCB3aXRoIGEgc3BlY2lmaWMgdHlwZSB3YXMgcmVjZWl2ZWQgd2l0aGluIHNvbWUgc3BlY2lmaWVkIHRpbWUuXG5cdCAqIFRoZSBwcm9taXNlIHdpbGwgYmUgcmVqZWN0ZWQgaWYgYSB0aW1lb3V0IG9jY3Vycy5cblx0ICovXG5cdHB1YmxpYyB3YWl0Rm9yRXZlbnQoZXZlbnRUeXBlOiBzdHJpbmcsIHRpbWVvdXQ/OiBudW1iZXIpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuRXZlbnQ+IHtcblxuXHRcdHRpbWVvdXQgPSB0aW1lb3V0IHx8IHRoaXMuZGVmYXVsdFRpbWVvdXQ7XG5cblx0XHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0dGhpcy5vbihldmVudFR5cGUsIGV2ZW50ID0+IHtcblx0XHRcdFx0cmVzb2x2ZShldmVudCk7XG5cdFx0XHR9KTtcblx0XHRcdGlmICghdGhpcy5fc29ja2V0KSB7XHQvLyBubyB0aW1lb3V0cyBpZiBkZWJ1Z2dpbmcgdGhlIHRlc3RzXG5cdFx0XHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0XHRcdHJlamVjdChuZXcgRXJyb3IoYG5vIGV2ZW50ICcke2V2ZW50VHlwZX0nIHJlY2VpdmVkIGFmdGVyICR7dGltZW91dH0gbXNgKSk7XG5cdFx0XHRcdH0sIHRpbWVvdXQpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0Lypcblx0ICogUmV0dXJucyBhIHByb21pc2UgdGhhdCB3aWxsIHJlc29sdmUgaWYgYW4gJ2luaXRpYWxpemVkJyBldmVudCB3YXMgcmVjZWl2ZWQgd2l0aGluIHNvbWUgc3BlY2lmaWVkIHRpbWVcblx0ICogYW5kIGEgc3Vic2VxdWVudCAnY29uZmlndXJhdGlvbkRvbmUnIHJlcXVlc3Qgd2FzIHN1Y2Nlc3NmdWxseSBleGVjdXRlZC5cblx0ICogVGhlIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCBpZiBhIHRpbWVvdXQgb2NjdXJzIG9yIGlmIHRoZSAnY29uZmlndXJhdGlvbkRvbmUnIHJlcXVlc3QgZmFpbHMuXG5cdCAqL1xuXHRwdWJsaWMgY29uZmlndXJhdGlvblNlcXVlbmNlKCk6IFByb21pc2U8YW55PiB7XG5cblx0XHRyZXR1cm4gdGhpcy53YWl0Rm9yRXZlbnQoJ2luaXRpYWxpemVkJykudGhlbihldmVudCA9PiB7XG5cdFx0XHRyZXR1cm4gdGhpcy5jb25maWd1cmF0aW9uRG9uZSgpO1xuXHRcdH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIGlmIGEgJ2luaXRpYWxpemUnIGFuZCBhICdsYXVuY2gnIHJlcXVlc3Qgd2VyZSBzdWNjZXNzZnVsLlxuXHQgKi9cblx0cHVibGljIGxhdW5jaChsYXVuY2hBcmdzOiBhbnkpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuTGF1bmNoUmVzcG9uc2U+IHtcblxuXHRcdHJldHVybiB0aGlzLmluaXRpYWxpemVSZXF1ZXN0KCkudGhlbihyZXNwb25zZSA9PiB7XG5cdFx0XHRpZiAocmVzcG9uc2UuYm9keSAmJiByZXNwb25zZS5ib2R5LnN1cHBvcnRzQ29uZmlndXJhdGlvbkRvbmVSZXF1ZXN0KSB7XG5cdFx0XHRcdHRoaXMuX3N1cHBvcnRzQ29uZmlndXJhdGlvbkRvbmVSZXF1ZXN0ID0gdHJ1ZTtcblx0XHRcdH1cblx0XHRcdHJldHVybiB0aGlzLmxhdW5jaFJlcXVlc3QobGF1bmNoQXJncyk7XG5cdFx0fSk7XG5cdH1cblxuXHRwcml2YXRlIGNvbmZpZ3VyYXRpb25Eb25lKCkgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuUmVzcG9uc2U+IHtcblx0XHRpZiAodGhpcy5fc3VwcG9ydHNDb25maWd1cmF0aW9uRG9uZVJlcXVlc3QpIHtcblx0XHRcdHJldHVybiB0aGlzLmNvbmZpZ3VyYXRpb25Eb25lUmVxdWVzdCgpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHQvLyBpZiBkZWJ1ZyBhZGFwdGVyIGRvZXNuJ3Qgc3VwcG9ydCB0aGUgY29uZmlndXJhdGlvbkRvbmVSZXF1ZXN0IHdlIGhhdmUgdG8gc2VuZCB0aGUgc2V0RXhjZXB0aW9uQnJlYWtwb2ludHNSZXF1ZXN0LlxuXHRcdFx0cmV0dXJuIHRoaXMuc2V0RXhjZXB0aW9uQnJlYWtwb2ludHNSZXF1ZXN0KHsgZmlsdGVyczogWyAnYWxsJyBdIH0pO1xuXHRcdH1cblx0fVxuXG5cdC8qXG5cdCAqIFJldHVybnMgYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIGlmIGEgJ3N0b3BwZWQnIGV2ZW50IHdhcyByZWNlaXZlZCB3aXRoaW4gc29tZSBzcGVjaWZpZWQgdGltZVxuXHQgKiBhbmQgdGhlIGV2ZW50J3MgcmVhc29uIGFuZCBsaW5lIG51bWJlciB3YXMgYXNzZXJ0ZWQuXG5cdCAqIFRoZSBwcm9taXNlIHdpbGwgYmUgcmVqZWN0ZWQgaWYgYSB0aW1lb3V0IG9jY3VycywgdGhlIGFzc2VydGlvbnMgZmFpbCwgb3IgaWYgdGhlICdzdGFja1RyYWNlJyByZXF1ZXN0IGZhaWxzLlxuXHQgKi9cblx0cHVibGljIGFzc2VydFN0b3BwZWRMb2NhdGlvbihyZWFzb246IHN0cmluZywgZXhwZWN0ZWQ6IHsgcGF0aD86IHN0cmluZywgbGluZT86IG51bWJlciwgY29sdW1uPzogbnVtYmVyIH0gKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5TdGFja1RyYWNlUmVzcG9uc2U+IHtcblxuXHRcdHJldHVybiB0aGlzLndhaXRGb3JFdmVudCgnc3RvcHBlZCcpLnRoZW4oZXZlbnQgPT4ge1xuXHRcdFx0YXNzZXJ0LmVxdWFsKGV2ZW50LmJvZHkucmVhc29uLCByZWFzb24pO1xuXHRcdFx0cmV0dXJuIHRoaXMuc3RhY2tUcmFjZVJlcXVlc3Qoe1xuXHRcdFx0XHR0aHJlYWRJZDogZXZlbnQuYm9keS50aHJlYWRJZFxuXHRcdFx0fSk7XG5cdFx0fSkudGhlbihyZXNwb25zZSA9PiB7XG5cdFx0XHRjb25zdCBmcmFtZSA9IHJlc3BvbnNlLmJvZHkuc3RhY2tGcmFtZXNbMF07XG5cdFx0XHRpZiAodHlwZW9mIGV4cGVjdGVkLnBhdGggPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdHRoaXMuYXNzZXJ0UGF0aChmcmFtZS5zb3VyY2UucGF0aCwgZXhwZWN0ZWQucGF0aCwgJ3N0b3BwZWQgbG9jYXRpb246IHBhdGggbWlzbWF0Y2gnKTtcblx0XHRcdH1cblx0XHRcdGlmICh0eXBlb2YgZXhwZWN0ZWQubGluZSA9PT0gJ251bWJlcicpIHtcblx0XHRcdFx0YXNzZXJ0LmVxdWFsKGZyYW1lLmxpbmUsIGV4cGVjdGVkLmxpbmUsICdzdG9wcGVkIGxvY2F0aW9uOiBsaW5lIG1pc21hdGNoJyk7XG5cdFx0XHR9XG5cdFx0XHRpZiAodHlwZW9mIGV4cGVjdGVkLmNvbHVtbiA9PT0gJ251bWJlcicpIHtcblx0XHRcdFx0YXNzZXJ0LmVxdWFsKGZyYW1lLmNvbHVtbiwgZXhwZWN0ZWQuY29sdW1uLCAnc3RvcHBlZCBsb2NhdGlvbjogY29sdW1uIG1pc21hdGNoJyk7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gcmVzcG9uc2U7XG5cdFx0fSk7XG5cdH1cblxuXHQvKlxuXHQgKiBSZXR1cm5zIGEgcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSBpZiBlbm91Z2ggb3V0cHV0IGV2ZW50cyB3aXRoIHRoZSBnaXZlbiBjYXRlZ29yeSBoYXZlIGJlZW4gcmVjZWl2ZWRcblx0ICogYW5kIHRoZSBjb25jYXRlbmF0ZWQgZGF0YSBtYXRjaCB0aGUgZXhwZWN0ZWQgZGF0YS5cblx0ICogVGhlIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCBhcyBzb29uIGFzIHRoZSByZWNlaXZlZCBkYXRhIGNhbm5vdCBtYXRjaCB0aGUgZXhwZWN0ZWQgZGF0YSBvciBpZiBhIHRpbWVvdXQgb2NjdXJzLlxuXHQgKi9cblx0cHVibGljIGFzc2VydE91dHB1dChjYXRlZ29yeTogc3RyaW5nLCBleHBlY3RlZDogc3RyaW5nLCB0aW1lb3V0PzogbnVtYmVyKTogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkV2ZW50PiB7XG5cblx0XHR0aW1lb3V0ID0gdGltZW91dCB8fCB0aGlzLmRlZmF1bHRUaW1lb3V0O1xuXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdGxldCBvdXRwdXQgPSAnJztcblx0XHRcdHRoaXMub24oJ291dHB1dCcsIGV2ZW50ID0+IHtcblx0XHRcdFx0Y29uc3QgZSA9IDxEZWJ1Z1Byb3RvY29sLk91dHB1dEV2ZW50PiBldmVudDtcblx0XHRcdFx0aWYgKGUuYm9keS5jYXRlZ29yeSA9PT0gY2F0ZWdvcnkpIHtcblx0XHRcdFx0XHRvdXRwdXQgKz0gZS5ib2R5Lm91dHB1dDtcblx0XHRcdFx0XHRpZiAob3V0cHV0LmluZGV4T2YoZXhwZWN0ZWQpID09PSAwKSB7XG5cdFx0XHRcdFx0XHRyZXNvbHZlKGV2ZW50KTtcblx0XHRcdFx0XHR9IGVsc2UgaWYgKGV4cGVjdGVkLmluZGV4T2Yob3V0cHV0KSAhPT0gMCkge1xuXHRcdFx0XHRcdFx0Y29uc3Qgc2FuaXRpemUgPSAoczogc3RyaW5nKSA9PiBzLnRvU3RyaW5nKCkucmVwbGFjZSgvXFxyL21nLCAnXFxcXHInKS5yZXBsYWNlKC9cXG4vbWcsICdcXFxcbicpO1xuXHRcdFx0XHRcdFx0cmVqZWN0KG5ldyBFcnJvcihgcmVjZWl2ZWQgZGF0YSAnJHtzYW5pdGl6ZShvdXRwdXQpfScgaXMgbm90IGEgcHJlZml4IG9mIHRoZSBleHBlY3RlZCBkYXRhICcke3Nhbml0aXplKGV4cGVjdGVkKX0nYCkpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0XHRpZiAoIXRoaXMuX3NvY2tldCkge1x0Ly8gbm8gdGltZW91dHMgaWYgZGVidWdnaW5nIHRoZSB0ZXN0c1xuXHRcdFx0XHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0XHRyZWplY3QobmV3IEVycm9yKGBub3QgZW5vdWdoIG91dHB1dCBkYXRhIHJlY2VpdmVkIGFmdGVyICR7dGltZW91dH0gbXNgKSk7XG5cdFx0XHRcdH0sIHRpbWVvdXQpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0cHVibGljIGFzc2VydFBhdGgocGF0aDogc3RyaW5nLCBleHBlY3RlZDogc3RyaW5nLCBtZXNzYWdlPzogc3RyaW5nKSB7XG5cdFx0aWYgKERlYnVnQ2xpZW50LkNBU0VfSU5TRU5TSVRJVkVfRklMRVNZU1RFTSkge1xuXHRcdFx0aWYgKHR5cGVvZiBwYXRoID09PSAnc3RyaW5nJykge1xuXHRcdFx0XHRwYXRoID0gcGF0aC50b0xvd2VyQ2FzZSgpO1xuXHRcdFx0fVxuXHRcdFx0aWYgKHR5cGVvZiBleHBlY3RlZCA9PT0gJ3N0cmluZycpIHtcblx0XHRcdFx0ZXhwZWN0ZWQgPSBleHBlY3RlZC50b0xvd2VyQ2FzZSgpO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRhc3NlcnQuZXF1YWwocGF0aCwgZXhwZWN0ZWQsIG1lc3NhZ2UpO1xuXHR9XG5cblx0Ly8gLS0tLSBzY2VuYXJpb3MgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cblx0LyoqXG5cdCAqIFJldHVybnMgYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIGlmIGEgY29uZmlndXJhYmxlIGJyZWFrcG9pbnQgaGFzIGJlZW4gaGl0IHdpdGhpbiBzb21lIHRpbWVcblx0ICogYW5kIHRoZSBldmVudCdzIHJlYXNvbiBhbmQgbGluZSBudW1iZXIgd2FzIGFzc2VydGVkLlxuXHQgKiBUaGUgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIGlmIGEgdGltZW91dCBvY2N1cnMsIHRoZSBhc3NlcnRpb25zIGZhaWwsIG9yIGlmIHRoZSByZXF1ZXN0cyBmYWlscy5cblx0ICovXG5cdHB1YmxpYyBoaXRCcmVha3BvaW50KGxhdW5jaEFyZ3M6IGFueSwgbG9jYXRpb246IHsgcGF0aDogc3RyaW5nLCBsaW5lOiBudW1iZXIsIGNvbHVtbj86IG51bWJlciwgdmVyaWZpZWQ/OiBib29sZWFuIH0sIGV4cGVjdGVkPzogeyBwYXRoPzogc3RyaW5nLCBsaW5lPzogbnVtYmVyLCBjb2x1bW4/OiBudW1iZXIsIHZlcmlmaWVkPzogYm9vbGVhbiB9KSA6IFByb21pc2U8YW55PiB7XG5cblx0XHRyZXR1cm4gUHJvbWlzZS5hbGwoW1xuXG5cdFx0XHR0aGlzLndhaXRGb3JFdmVudCgnaW5pdGlhbGl6ZWQnKS50aGVuKGV2ZW50ID0+IHtcblx0XHRcdFx0cmV0dXJuIHRoaXMuc2V0QnJlYWtwb2ludHNSZXF1ZXN0KHtcblx0XHRcdFx0XHRsaW5lczogWyBsb2NhdGlvbi5saW5lIF0sXG5cdFx0XHRcdFx0YnJlYWtwb2ludHM6IFsgeyBsaW5lOiBsb2NhdGlvbi5saW5lLCBjb2x1bW46IGxvY2F0aW9uLmNvbHVtbiB9IF0sXG5cdFx0XHRcdFx0c291cmNlOiB7IHBhdGg6IGxvY2F0aW9uLnBhdGggfVxuXHRcdFx0XHR9KTtcblx0XHRcdH0pLnRoZW4ocmVzcG9uc2UgPT4ge1xuXG5cdFx0XHRcdGNvbnN0IGJwID0gcmVzcG9uc2UuYm9keS5icmVha3BvaW50c1swXTtcblxuXHRcdFx0XHRjb25zdCB2ZXJpZmllZCA9ICh0eXBlb2YgbG9jYXRpb24udmVyaWZpZWQgPT09ICdib29sZWFuJykgPyBsb2NhdGlvbi52ZXJpZmllZCA6IHRydWU7XG5cdFx0XHRcdGFzc2VydC5lcXVhbChicC52ZXJpZmllZCwgdmVyaWZpZWQsICdicmVha3BvaW50IHZlcmlmaWNhdGlvbiBtaXNtYXRjaDogdmVyaWZpZWQnKTtcblxuXHRcdFx0XHRpZiAoYnAuc291cmNlICYmIGJwLnNvdXJjZS5wYXRoKSB7XG5cdFx0XHRcdFx0dGhpcy5hc3NlcnRQYXRoKGJwLnNvdXJjZS5wYXRoLCBsb2NhdGlvbi5wYXRoLCAnYnJlYWtwb2ludCB2ZXJpZmljYXRpb24gbWlzbWF0Y2g6IHBhdGgnKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRpZiAodHlwZW9mIGJwLmxpbmUgPT09ICdudW1iZXInKSB7XG5cdFx0XHRcdFx0YXNzZXJ0LmVxdWFsKGJwLmxpbmUsIGxvY2F0aW9uLmxpbmUsICdicmVha3BvaW50IHZlcmlmaWNhdGlvbiBtaXNtYXRjaDogbGluZScpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmICh0eXBlb2YgbG9jYXRpb24uY29sdW1uID09PSAnbnVtYmVyJyAmJiB0eXBlb2YgYnAuY29sdW1uID09PSAnbnVtYmVyJykge1xuXHRcdFx0XHRcdGFzc2VydC5lcXVhbChicC5jb2x1bW4sIGxvY2F0aW9uLmNvbHVtbiwgJ2JyZWFrcG9pbnQgdmVyaWZpY2F0aW9uIG1pc21hdGNoOiBjb2x1bW4nKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRyZXR1cm4gdGhpcy5jb25maWd1cmF0aW9uRG9uZSgpO1xuXHRcdFx0fSksXG5cblx0XHRcdHRoaXMubGF1bmNoKGxhdW5jaEFyZ3MpLFxuXG5cdFx0XHR0aGlzLmFzc2VydFN0b3BwZWRMb2NhdGlvbignYnJlYWtwb2ludCcsIGV4cGVjdGVkIHx8IGxvY2F0aW9uKVxuXG5cdFx0XSk7XG5cdH1cbn1cbiJdfQ==