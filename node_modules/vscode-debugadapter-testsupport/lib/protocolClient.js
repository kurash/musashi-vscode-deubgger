/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var ee = require('events');
var ProtocolClient = (function (_super) {
    __extends(ProtocolClient, _super);
    function ProtocolClient() {
        _super.call(this);
        this.pendingRequests = new Map();
        this.rawData = new Buffer(0);
        this.sequence = 1;
        this.contentLength = -1;
    }
    ProtocolClient.prototype.connect = function (readable, writable) {
        var _this = this;
        this.outputStream = writable;
        readable.on('data', function (data) {
            _this.handleData(data);
        });
    };
    ProtocolClient.prototype.send = function (command, args) {
        var _this = this;
        return new Promise(function (completeDispatch, errorDispatch) {
            _this.doSend(command, args, function (result) {
                if (result.success) {
                    completeDispatch(result);
                }
                else {
                    errorDispatch(new Error(result.message));
                }
            });
        });
    };
    ProtocolClient.prototype.doSend = function (command, args, clb) {
        var request = {
            type: 'request',
            seq: this.sequence++,
            command: command
        };
        if (args && Object.keys(args).length > 0) {
            request.arguments = args;
        }
        // store callback for this request
        this.pendingRequests.set(request.seq, clb);
        var json = JSON.stringify(request);
        this.outputStream.write("Content-Length: " + Buffer.byteLength(json, 'utf8') + "\r\n\r\n" + json, 'utf8');
    };
    ProtocolClient.prototype.handleData = function (data) {
        this.rawData = Buffer.concat([this.rawData, data]);
        while (true) {
            if (this.contentLength >= 0) {
                if (this.rawData.length >= this.contentLength) {
                    var message = this.rawData.toString('utf8', 0, this.contentLength);
                    this.rawData = this.rawData.slice(this.contentLength);
                    this.contentLength = -1;
                    if (message.length > 0) {
                        this.dispatch(message);
                    }
                    continue; // there may be more complete messages to process
                }
            }
            else {
                var idx = this.rawData.indexOf(ProtocolClient.TWO_CRLF);
                if (idx !== -1) {
                    var header = this.rawData.toString('utf8', 0, idx);
                    var lines = header.split('\r\n');
                    for (var i = 0; i < lines.length; i++) {
                        var pair = lines[i].split(/: +/);
                        if (pair[0] === 'Content-Length') {
                            this.contentLength = +pair[1];
                        }
                    }
                    this.rawData = this.rawData.slice(idx + ProtocolClient.TWO_CRLF.length);
                    continue;
                }
            }
            break;
        }
    };
    ProtocolClient.prototype.dispatch = function (body) {
        var rawData = JSON.parse(body);
        if (typeof rawData.event !== 'undefined') {
            var event_1 = rawData;
            this.emit(event_1.event, event_1);
        }
        else {
            var response = rawData;
            var clb = this.pendingRequests.get(response.request_seq);
            if (clb) {
                this.pendingRequests.delete(response.request_seq);
                clb(response);
            }
        }
    };
    ProtocolClient.TWO_CRLF = '\r\n\r\n';
    return ProtocolClient;
}(ee.EventEmitter));
exports.ProtocolClient = ProtocolClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdG9jb2xDbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcHJvdG9jb2xDbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztnR0FHZ0c7Ozs7Ozs7QUFHaEcsSUFBWSxFQUFFLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFHN0I7SUFBb0Msa0NBQWU7SUFVbEQ7UUFDQyxpQkFBTyxDQUFDO1FBTEQsb0JBQWUsR0FBRyxJQUFJLEdBQUcsRUFBK0MsQ0FBQztRQUN6RSxZQUFPLEdBQUcsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFLL0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDbEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRVMsZ0NBQU8sR0FBakIsVUFBa0IsUUFBeUIsRUFBRSxRQUF5QjtRQUF0RSxpQkFPQztRQUxBLElBQUksQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDO1FBRTdCLFFBQVEsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLFVBQUMsSUFBWTtZQUNoQyxLQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVNLDZCQUFJLEdBQVgsVUFBWSxPQUFlLEVBQUUsSUFBVTtRQUF2QyxpQkFXQztRQVRBLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFDLGdCQUFnQixFQUFFLGFBQWE7WUFDbEQsS0FBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLFVBQUMsTUFBOEI7Z0JBQ3pELEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO29CQUNwQixnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDMUIsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDUCxhQUFhLENBQUMsSUFBSSxLQUFLLENBQUMsTUFB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QUFBRCxDQUFDLEFBMUdELENBQW9DLEVBQUUsQ0FBQyxZQUFZLEdBMEdsRDtBQTFHWSxzQkFBYyxpQkEwRzFCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICogIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4gU2VlIExpY2Vuc2UudHh0IGluIHRoZSBwcm9qZWN0IHJvb3QgZm9yIGxpY2Vuc2UgaW5mb3JtYXRpb24uXG4gKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cblxuaW1wb3J0IHN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpO1xuaW1wb3J0ICogYXMgZWUgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7RGVidWdQcm90b2NvbH0gZnJvbSAndnNjb2RlLWRlYnVncHJvdG9jb2wnO1xuXG5leHBvcnQgY2xhc3MgUHJvdG9jb2xDbGllbnQgZXh0ZW5kcyBlZS5FdmVudEVtaXR0ZXIge1xuXG5cdHByaXZhdGUgc3RhdGljIFRXT19DUkxGID0gJ1xcclxcblxcclxcbic7XG5cblx0cHJpdmF0ZSBvdXRwdXRTdHJlYW06IHN0cmVhbS5Xcml0YWJsZTtcblx0cHJpdmF0ZSBzZXF1ZW5jZTogbnVtYmVyO1xuXHRwcml2YXRlIHBlbmRpbmdSZXF1ZXN0cyA9IG5ldyBNYXA8bnVtYmVyLCAoZTogRGVidWdQcm90b2NvbC5SZXNwb25zZSkgPT4gdm9pZD4oKTtcblx0cHJpdmF0ZSByYXdEYXRhID0gbmV3IEJ1ZmZlcigwKTtcblx0cHJpdmF0ZSBjb250ZW50TGVuZ3RoOiBudW1iZXI7XG5cblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0c3VwZXIoKTtcblx0XHR0aGlzLnNlcXVlbmNlID0gMTtcblx0XHR0aGlzLmNvbnRlbnRMZW5ndGggPSAtMTtcblx0fVxuXG5cdHByb3RlY3RlZCBjb25uZWN0KHJlYWRhYmxlOiBzdHJlYW0uUmVhZGFibGUsIHdyaXRhYmxlOiBzdHJlYW0uV3JpdGFibGUpOiB2b2lkIHtcblxuXHRcdHRoaXMub3V0cHV0U3RyZWFtID0gd3JpdGFibGU7XG5cblx0XHRyZWFkYWJsZS5vbignZGF0YScsIChkYXRhOiBCdWZmZXIpID0+IHtcblx0XHRcdHRoaXMuaGFuZGxlRGF0YShkYXRhKTtcblx0XHR9KTtcblx0fVxuXG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6IHN0cmluZywgYXJncz86IGFueSk6IFByb21pc2U8RGVidWdQcm90b2NvbC5SZXNwb25zZT4ge1xuXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChjb21wbGV0ZURpc3BhdGNoLCBlcnJvckRpc3BhdGNoKSA9PiB7XG5cdFx0XHR0aGlzLmRvU2VuZChjb21tYW5kLCBhcmdzLCAocmVzdWx0OiBEZWJ1Z1Byb3RvY29sLlJlc3BvbnNlKSA9PiB7XG5cdFx0XHRcdGlmIChyZXN1bHQuc3VjY2Vzcykge1xuXHRcdFx0XHRcdGNvbXBsZXRlRGlzcGF0Y2gocmVzdWx0KTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRlcnJvckRpc3BhdGNoKG5ldyBFcnJvcihyZXN1bHQubWVzc2FnZSkpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHR9KTtcblx0fVxuXG5cdHByaXZhdGUgZG9TZW5kKGNvbW1hbmQ6IHN0cmluZywgYXJnczogYW55LCBjbGI6IChyZXN1bHQ6IERlYnVnUHJvdG9jb2wuUmVzcG9uc2UpID0+IHZvaWQpOiB2b2lkIHtcblxuXHRcdGNvbnN0IHJlcXVlc3Q6IERlYnVnUHJvdG9jb2wuUmVxdWVzdCA9IHtcblx0XHRcdHR5cGU6ICdyZXF1ZXN0Jyxcblx0XHRcdHNlcTogdGhpcy5zZXF1ZW5jZSsrLFxuXHRcdFx0Y29tbWFuZDogY29tbWFuZFxuXHRcdH07XG5cdFx0aWYgKGFyZ3MgJiYgT2JqZWN0LmtleXMoYXJncykubGVuZ3RoID4gMCkge1xuXHRcdFx0cmVxdWVzdC5hcmd1bWVudHMgPSBhcmdzO1xuXHRcdH1cblxuXHRcdC8vIHN0b3JlIGNhbGxiYWNrIGZvciB0aGlzIHJlcXVlc3Rcblx0XHR0aGlzLnBlbmRpbmdSZXF1ZXN0cy5zZXQocmVxdWVzdC5zZXEsIGNsYik7XG5cblx0XHRjb25zdCBqc29uID0gSlNPTi5zdHJpbmdpZnkocmVxdWVzdCk7XG5cdFx0dGhpcy5vdXRwdXRTdHJlYW0ud3JpdGUoYENvbnRlbnQtTGVuZ3RoOiAke0J1ZmZlci5ieXRlTGVuZ3RoKGpzb24sICd1dGY4Jyl9XFxyXFxuXFxyXFxuJHtqc29ufWAsICd1dGY4Jyk7XG5cdH1cblxuXHRwcml2YXRlIGhhbmRsZURhdGEoZGF0YTogQnVmZmVyKTogdm9pZCB7XG5cblx0XHR0aGlzLnJhd0RhdGEgPSBCdWZmZXIuY29uY2F0KFt0aGlzLnJhd0RhdGEsIGRhdGFdKTtcblxuXHRcdHdoaWxlICh0cnVlKSB7XG5cdFx0XHRpZiAodGhpcy5jb250ZW50TGVuZ3RoID49IDApIHtcblx0XHRcdFx0aWYgKHRoaXMucmF3RGF0YS5sZW5ndGggPj0gdGhpcy5jb250ZW50TGVuZ3RoKSB7XG5cdFx0XHRcdFx0Y29uc3QgbWVzc2FnZSA9IHRoaXMucmF3RGF0YS50b1N0cmluZygndXRmOCcsIDAsIHRoaXMuY29udGVudExlbmd0aCk7XG5cdFx0XHRcdFx0dGhpcy5yYXdEYXRhID0gdGhpcy5yYXdEYXRhLnNsaWNlKHRoaXMuY29udGVudExlbmd0aCk7XG5cdFx0XHRcdFx0dGhpcy5jb250ZW50TGVuZ3RoID0gLTE7XG5cdFx0XHRcdFx0aWYgKG1lc3NhZ2UubGVuZ3RoID4gMCkge1xuXHRcdFx0XHRcdFx0dGhpcy5kaXNwYXRjaChtZXNzYWdlKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0Y29udGludWU7XHQvLyB0aGVyZSBtYXkgYmUgbW9yZSBjb21wbGV0ZSBtZXNzYWdlcyB0byBwcm9jZXNzXG5cdFx0XHRcdH1cblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGNvbnN0IGlkeCA9IHRoaXMucmF3RGF0YS5pbmRleE9mKFByb3RvY29sQ2xpZW50LlRXT19DUkxGKTtcblx0XHRcdFx0aWYgKGlkeCAhPT0gLTEpIHtcblx0XHRcdFx0XHRjb25zdCBoZWFkZXIgPSB0aGlzLnJhd0RhdGEudG9TdHJpbmcoJ3V0ZjgnLCAwLCBpZHgpO1xuXHRcdFx0XHRcdGNvbnN0IGxpbmVzID0gaGVhZGVyLnNwbGl0KCdcXHJcXG4nKTtcblx0XHRcdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRcdFx0XHRjb25zdCBwYWlyID0gbGluZXNbaV0uc3BsaXQoLzogKy8pO1xuXHRcdFx0XHRcdFx0aWYgKHBhaXJbMF0gPT09ICdDb250ZW50LUxlbmd0aCcpIHtcblx0XHRcdFx0XHRcdFx0dGhpcy5jb250ZW50TGVuZ3RoID0gK3BhaXJbMV07XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdHRoaXMucmF3RGF0YSA9IHRoaXMucmF3RGF0YS5zbGljZShpZHggKyBQcm90b2NvbENsaWVudC5UV09fQ1JMRi5sZW5ndGgpO1xuXHRcdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRicmVhaztcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGRpc3BhdGNoKGJvZHk6IHN0cmluZyk6IHZvaWQge1xuXG5cdFx0Y29uc3QgcmF3RGF0YSA9IEpTT04ucGFyc2UoYm9keSk7XG5cblx0XHRpZiAodHlwZW9mIHJhd0RhdGEuZXZlbnQgIT09ICd1bmRlZmluZWQnKSB7XG5cdFx0XHRjb25zdCBldmVudCA9IDxEZWJ1Z1Byb3RvY29sLkV2ZW50PiByYXdEYXRhO1xuXHRcdFx0dGhpcy5lbWl0KGV2ZW50LmV2ZW50LCBldmVudCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnN0IHJlc3BvbnNlID0gPERlYnVnUHJvdG9jb2wuUmVzcG9uc2U+IHJhd0RhdGE7XG5cdFx0XHRjb25zdCBjbGIgPSB0aGlzLnBlbmRpbmdSZXF1ZXN0cy5nZXQocmVzcG9uc2UucmVxdWVzdF9zZXEpO1xuXHRcdFx0aWYgKGNsYikge1xuXHRcdFx0XHR0aGlzLnBlbmRpbmdSZXF1ZXN0cy5kZWxldGUocmVzcG9uc2UucmVxdWVzdF9zZXEpO1xuXHRcdFx0XHRjbGIocmVzcG9uc2UpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxufVxuIl19